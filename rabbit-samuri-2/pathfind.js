"use strict";!function(){var t=[];function e(){var e;return(e=t.length?t.pop():new function(){this.parent=null,this.x=0,this.y=0,this.f=0,this.g=0,this.h=0}).parent=null,e.x=0,e.y=0,e.f=0,e.g=0,e.h=0,e}function i(e){t.length<64e3&&t.push(e)}function s(t,e){this.x=t||0,this.y=e||0}var n=[];function o(){return n.length?n.pop():new s(0,0)}function r(t){n.length<1e4&&n.push(t)}var h="undefined"!=typeof Worker,a="undefined"==typeof document,l=null,p=a?"":document.currentScript.src;function d(){this.hcells=0,this.vcells=0,this.pathEnd=e(),this.cells=null,this.openList=[],this.closedList=[],this.closedCache={},this.pathList=[],this.currentNode=null,this.targetX=0,this.targetY=0,this.diagonalsEnabled=!0,this.worker=null,this.workerQueue=[],this.workerRecycle=[],this.sendMessageQueue=[];var t=this;h&&!a&&function(t,e){if(window.resolveLocalFileSystemURL){var i=function(t){console.error("Error creating worker: ",t)},s=window.cordova.file.applicationDirectory+"www/pathfind.js";window.resolveLocalFileSystemURL(s,function(t){t.file(function(t){var s=new FileReader;s.onerror=i,s.onload=function(t){var i=t.target.result,s=new Blob([i],{type:"application/javascript"}),n=new Worker(URL.createObjectURL(s));e(n)},s.readAsArrayBuffer(t)},i)},i)}else"undefined"!=typeof URL&&new URL("http://example.com").origin&&location.origin&&location.origin!==new URL(t).origin?fetch(t).then(function(t){return t.blob()}).then(function(t){var i=URL.createObjectURL(t);e(new Worker(i))}):e(new Worker(t))}(p,function(e){t.worker=e,t.worker.addEventListener("message",function(e){if(e&&e.data&&"result"===e.data.cmd){if(e.data.pathList){for(i=0,s=t.pathList.length;i<s;i++)r(t.pathList[i]);t.pathList=e.data.pathList,t.workerQueue[0].success()}else t.workerQueue[0].fail();t.workerRecycle.push(t.workerQueue.shift())}},!1),t.worker.addEventListener("error",function(t){console.error(t)},!1),t.worker.postMessage(null);for(var i=0,s=t.sendMessageQueue.length;i<s;++i)t.worker.postMessage(t.sendMessageQueue[i]);t.sendMessageQueue.length=0})}function c(t){return t<0?-t:t}a&&self.addEventListener("message",function(t){var e=t.data;e&&("init"===e.cmd?(l||(l=new d),l.init(e.hcells,e.vcells,e.data,e.diagonals)):"find"===e.cmd?(l.pathEnd.parent=null,l.targetX=e.endX,l.targetY=e.endY,l.doLongFindPath(e.startX,e.startY)?self.postMessage({cmd:"result",pathList:l.pathList}):self.postMessage({cmd:"result",pathList:null})):"region"===e.cmd?l.writeCells(e.offx,e.offy,e.lenx,e.leny,e.data):"setdiag"===e.cmd&&l&&(l.diagonalsEnabled=e.diagonals))},!1),d.prototype.postToWorker=function(t){this.worker?this.worker.postMessage(t):this.sendMessageQueue.push(t)},d.prototype.init=function(t,e,i,s){this.hcells=t,this.vcells=e,this.cells=i,this.diagonalsEnabled=s,h&&!a&&this.postToWorker({cmd:"init",hcells:t,vcells:e,diagonals:s,data:i})},d.prototype.updateRegion=function(t,e,i,s,n){this.writeCells(t,e,i,s,n),h&&!a&&this.postToWorker({cmd:"region",offx:t,offy:e,lenx:i,leny:s,data:n})},d.prototype.writeCells=function(t,e,i,s,n){var o,r;for(o=0;o<i;++o)for(r=0;r<s;++r)this.cells[t+o][e+r]=n[o][r]},d.prototype.unsetReady=function(){this.cells=null},d.prototype.isReady=function(){return!!this.cells},d.prototype.setDiagonals=function(t){this.diagonalsEnabled!==t&&(this.diagonalsEnabled=t,h&&!a&&this.postToWorker({cmd:"setdiag",diagonals:t}))},d.prototype.at=function(t,e){return t<0||e<0||t>=this.hcells||e>=this.vcells?32767:this.cells[t][e]},d.prototype.findPath=function(t,e,i,s,n,a){if(this.cells){t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),s=Math.floor(s),this.targetX=i,this.targetY=s,this.pathEnd.parent=null;var l=Math.min(t,i),p=Math.max(t,i),d=Math.min(e,s),c=Math.max(e,s);if(l<0||d<0||p>=this.hcells||c>=this.vcells)a();else{var u,f,g,L,w,y;if(this.diagonalsEnabled){var v=!0;for(u=l;u<=p;u++)for(f=d;f<=c;f++)if(0!==this.cells[u][f]){v=!1,u=p+1;break}if(v){for(g=0,L=this.pathList.length;g<L;g++)r(this.pathList[g]);return this.pathList.length=0,this.pathEnd.x=i,this.pathEnd.y=s,this.pathEnd.parent=null,(y=o()).x=i,y.y=s,this.pathList.push(y),void n()}}h?((w=this.workerRecycle.length?this.workerRecycle.pop():{}).success=n,w.fail=a,this.workerQueue.push(w),this.postToWorker({cmd:"find",startX:t,startY:e,endX:i,endY:s})):this.doLongFindPath(t,e)?n():a()}}else a()},d.prototype.doLongFindPath=function(t,s){var n,h,a,l,p,d,c=8,u=-1;for(n=0,h=this.openList.length;n<h;n++)i(this.openList[n]);for(n=0,h=this.closedList.length;n<h;n++)i(this.closedList[n]);for(n=0,h=this.pathList.length;n<h;n++)r(this.pathList[n]);this.openList.length=0,this.closedList.length=0,this.closedCache={},this.pathList.length=0;var f=e();f.x=t,f.y=s,this.openList.push(f);for(var g=!1,L=!1,w=!1,y=!1,v=this.diagonalsEnabled;this.openList.length;){if(a=this.openList.shift(),this.closedList.unshift(a),this.closedCache[((a.x<<16)+a.y).toString()]=!0,a.x===this.targetX&&a.y===this.targetY){for(this.pathEnd.parent=a.parent,this.pathEnd.x=a.x,this.pathEnd.y=a.y,p=this.pathEnd;p;)0===this.pathList.length?(d=!0,p.parent&&(u=c=this.nodeDirection(p,p.parent))):d=!!p.parent&&(u=this.nodeDirection(p,p.parent))!==c,d&&((l=o()).x=p.x,l.y=p.y,this.pathList.unshift(l),c=u),p=p.parent;return!0}this.currentNode=a;var k=a.x,m=a.y;g=32767===this.at(k-1,m),L=32767===this.at(k,m-1),w=32767===this.at(k+1,m),y=32767===this.at(k,m+1),g||this.addCellToOpenList(k-1,m,10),!v||g||L||32767===this.at(k-1,m-1)||this.addCellToOpenList(k-1,m-1,14),L||this.addCellToOpenList(k,m-1,10),!v||L||w||32767===this.at(k+1,m-1)||this.addCellToOpenList(k+1,m-1,14),w||this.addCellToOpenList(k+1,m,10),!v||w||y||32767===this.at(k+1,m+1)||this.addCellToOpenList(k+1,m+1,14),y||this.addCellToOpenList(k,m+1,10),!v||y||g||32767===this.at(k-1,m+1)||this.addCellToOpenList(k-1,m+1,14)}return!1},d.prototype.insertToOpenList=function(t){var e,i;if(t.f>=this.openList[this.openList.length-1].f)this.openList.push(t);else for(e=0,i=this.openList.length;e<i;e++)if(t.f<this.openList[e].f){this.openList.splice(e,0,t);break}},d.prototype.addCellToOpenList=function(t,i,s){if(!this.closedCache.hasOwnProperty(((t<<16)+i).toString())){var n,o,r,h=this.at(t,i);for(n=0,o=this.openList.length;n<o;n++)if(t===(r=this.openList[n]).x&&i===r.y){if(this.currentNode.g+s+h<r.g){if(r.parent=this.currentNode,r.g=this.currentNode.g+s+h,r.h=this.estimateH(r.x,r.y),r.f=r.g+r.h,1===this.openList.length)return;this.openList.splice(n,1),this.insertToOpenList(r)}return}(r=e()).x=t,r.y=i,r.h=this.estimateH(t,i),r.g=this.currentNode.g+s+h,r.f=r.h+r.g,r.parent=this.currentNode,this.openList.length?this.insertToOpenList(r):this.openList.push(r)}},d.prototype.estimateH=function(t,e){return 10*c(t-this.targetX)+10*c(e-this.targetY)},d.prototype.nodeDirection=function(t,e){var i=t.x,s=t.y,n=e.x,o=e.y;if(i===n){if(o>s)return 6;if(o<s)return 2;if(s==o)return 8}else if(s===o){if(n>i)return 4;if(o<i)return 0}else{if(n<i&&o<s)return 1;if(n>i&&o<s)return 3;if(n<i&&o>s)return 7;if(n>i&&o>s)return 5}return 8},a||(window.PF_CLEAR=0,window.PF_OBSTACLE=32767,window.Pathfinder=d,window.ResultNode=s,window.allocResultNode=o,window.freeResultNode=r)}();